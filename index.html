<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <title>BIBORIA: Forest Harmony</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

  <style>
    /* --- P.15 ä»‹é¢é¢¨æ ¼è¨­è¨ˆ --- */
    @import url('https://fonts.googleapis.com/css2?family=Varela+Round&display=swap');

    body { margin: 0; overflow: hidden; font-family: 'Varela Round', sans-serif; }

    /* UI è¦†è“‹å±¤ */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° VR å ´æ™¯ */
      z-index: 999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }

    /* é€šç”¨æŒ‰éˆ•æ¨£å¼ */
    .btn {
      pointer-events: auto;
      background: #8CC63F; color: white;
      border: 4px solid white; border-radius: 50px;
      padding: 15px 40px; font-size: 1.5rem; font-weight: bold;
      cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.95); }
    .hidden { display: none !important; }

    /* 1. é–‹å§‹ç•«é¢ (State A) */
    #start-screen {
      background: rgba(255, 255, 255, 0.8);
      width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      pointer-events: auto;
    }
    .logo { font-size: 4rem; color: #5D4037; margin-bottom: 10px; }
    .subtitle { font-size: 1.5rem; color: #8CC63F; margin-bottom: 30px; }

    /* 2. éŠæˆ²ä¸­ HUD (äº’å‹•æç¤º) */
    #hud {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    }
    
    /* é è¿‘æ™‚çš„æç¤ºæ¡† */
    #interaction-hint {
      position: absolute; top: 20%; left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 25px; border-radius: 20px;
      color: #5D4037; font-weight: bold; font-size: 1.2rem;
      display: none; /* é è¨­éš±è— */
      animation: float 2s infinite ease-in-out;
    }
    @keyframes float { 0%,100%{transform:translateX(-50%) translateY(0);} 50%{transform:translateX(-50%) translateY(-10px);} }

    /* å·¦ä¸Šè§’é¸å–® */
    .menu-btn {
      position: absolute; top: 20px; left: 20px;
      width: 50px; height: 50px; background: #8CC63F; border-radius: 50%;
      border: 3px solid white; pointer-events: auto; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
    }

    /* å³ä¸‹è§’åˆå¥æŒ‰éˆ• (State D) */
    #ensemble-btn {
      position: absolute; bottom: 30px; right: 30px;
      width: 80px; height: 80px; border-radius: 50%;
      background: #8CC63F; color: white; border: 4px solid white;
      font-size: 2rem; display: flex; justify-content: center; align-items: center;
      pointer-events: auto; cursor: pointer;
      box-shadow: 0 0 15px #8CC63F;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

    /* 3. çµå°¾ç•«é¢ (State E) */
    #end-screen {
      background: black; color: white;
      width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 2s; pointer-events: none;
    }

    /* Loading */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #8CC63F; display: flex; justify-content: center; align-items: center;
      z-index: 10000; color: white; font-size: 2rem;
    }
  </style>
</head>

<body>
  <div id="loader">Loading Assets...</div>

  <div id="ui-layer">
    
    <div id="start-screen">
      <div class="logo">BIBORIA</div>
      <div class="subtitle">Forest Harmony Journey</div>
      <button class="btn" id="start-btn">START GAME</button>
    </div>

    <div id="hud" class="hidden">
      <div class="menu-btn">â˜°</div>
      <div id="interaction-hint">ğŸµ é è¿‘é¡¯ç¤ºåœ–æ¨™å³å‡ºè²</div>
      <div id="ensemble-btn" class="hidden">B</div>
    </div>

    <div id="end-screen" class="hidden">
      <h1>Grand Concert!</h1>
      <p>æˆ‘å€‘ä¸‹æ¬¡è¦‹ï¼</p>
    </div>
  </div>

  <a-scene environment="preset: forest; skyType: atmosphere; lighting: point; groundColor: #5ea83e; shadow: true">
    
    <a-assets>
      <a-asset-item id="sheep-model" src="assets/models/sheep.glb"></a-asset-item>
      <a-asset-item id="frog-model" src="assets/models/frog.glb"></a-asset-item>
      <a-asset-item id="mushroom-model" src="assets/models/mushroom.glb"></a-asset-item>
      <a-asset-item id="bird-model" src="assets/models/bird.glb"></a-asset-item>
      <a-asset-item id="flower-model" src="assets/models/flower.glb"></a-asset-item>
      <a-asset-item id="rock-model" src="assets/models/rock.glb"></a-asset-item>
      <a-asset-item id="tree-model" src="assets/models/tree.glb"></a-asset-item>
    </a-assets>

    <a-entity id="rig" movement-controls="speed: 0.15" position="0 0 5">
      
      <a-entity camera position="0 2 3" look-controls="pointerLockEnabled: true">
        <a-cursor color="white" opacity="0.5" scale="0.5 0.5 0.5" visible="false"></a-cursor>
      </a-entity>

      <a-entity id="bibo" 
                gltf-model="#sheep-model" 
                position="0 0.2 -2" 
                rotation="0 180 0" 
                scale="0.4 0.4 0.4"
                bibo-walker
                bibo-interactor>
      </a-entity>
    </a-entity>

    <a-entity id="frog" 
              gltf-model="#frog-model" 
              position="-3 0 -4" 
              rotation="0 45 0"
              scale="0.3 0.3 0.3"
              npc-behavior="type: frog">
    </a-entity>

    <a-entity id="mushroom" 
              gltf-model="#mushroom-model" 
              position="3 0 -3" 
              scale="0.4 0.4 0.4"
              npc-behavior="type: mushroom">
    </a-entity>

    <a-entity id="rock" 
              gltf-model="#rock-model" 
              position="-5 0.5 2" 
              scale="0.6 0.6 0.6"
              npc-behavior="type: rock">
    </a-entity>

    <a-entity id="flower" 
              gltf-model="#flower-model" 
              position="5 0 3" 
              scale="0.8 0.8 0.8"
              npc-behavior="type: flower">
        <a-text value="â™ª" position="0 2 0" color="#FF69B4" align="center" scale="3 3 3" visible="false" id="flower-note"></a-text>
    </a-entity>

    <a-entity id="tree" 
              gltf-model="#tree-model" 
              position="0 0 -10" 
              scale="1.5 1.5 1.5"
              npc-behavior="type: tree">
    </a-entity>

    <a-entity position="6 0 -8" rotation="0 -30 0">
        <a-box position="0 1 0" color="#8B4513" depth="2" height="2" width="2"></a-box>
        <a-cone position="0 2.5 0" color="#A52A2A" radius-bottom="1.5" height="1.5"></a-cone>
        
        <a-entity id="bird" 
                  gltf-model="#bird-model" 
                  position="0 2.2 0" 
                  scale="0.2 0.2 0.2"
                  npc-behavior="type: bird">
        </a-entity>
    </a-entity>

  </a-scene>

  <script>
    // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
    const startScreen = document.getElementById('start-screen');
    const hud = document.getElementById('hud');
    const endScreen = document.getElementById('end-screen');
    const ensembleBtn = document.getElementById('ensemble-btn');
    let collectedNpcs = 0; // ç´€éŒ„äº’å‹•éçš„ NPC æ•¸é‡

    // ç§»é™¤ Loading
    document.querySelector('a-scene').addEventListener('loaded', function () {
      document.getElementById('loader').style.display = 'none';
    });

    // é–‹å§‹æŒ‰éˆ•
    document.getElementById('start-btn').addEventListener('click', function() {
      startScreen.classList.add('hidden');
      hud.classList.remove('hidden');
      // é€™è£¡å¯ä»¥æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
    });

    // åˆå¥æŒ‰éˆ• (çµæŸéŠæˆ²)
    ensembleBtn.addEventListener('click', function() {
      // è§¸ç™¼å¤§åˆå¥é‚è¼¯ (é€™è£¡ç°¡åŒ–ç‚ºç›´æ¥é€²å…¥çµæŸç•«é¢)
      hud.classList.add('hidden');
      endScreen.classList.remove('hidden');
      endScreen.style.opacity = 1;
      endScreen.style.pointerEvents = 'auto';
    });


    // --- Bibo èµ°è·¯èˆ‡äº’å‹•æ§åˆ¶ ---
    AFRAME.registerComponent('bibo-walker', {
      init: function () {
        this.timer = 0;
        this.isShaking = false;
        // åˆå§‹ä½ç½®
        this.baseY = 0.2; 
      },
      tick: function (time, timeDelta) {
        // 1. èµ°è·¯æ¨¡æ“¬ï¼šåµæ¸¬æ˜¯å¦æœ‰æŒ‰éµè¼¸å…¥ (ç°¡æ˜“åˆ¤æ–· Rig æ˜¯å¦åœ¨ç§»å‹•)
        // ç”±æ–¼ç›´æ¥åµæ¸¬ Rig ç§»å‹•è¼ƒè¤‡é›œï¼Œæˆ‘å€‘å‡è¨­åªè¦ä¸æ˜¯åœ¨äº’å‹•ï¼Œä¸”æœ‰æ™‚é–“æµé€ï¼Œå°±åšå¾®å¹…å‘¼å¸ï¼Œ
        // å¦‚æœè¦åš´æ ¼èµ°è·¯å‹•ç•«ï¼Œå¯ä»¥ç›£è½ keydownã€‚
        // é€™è£¡åšã€Œå‘¼å¸å¼å¾…æ©Ÿã€+ã€Œç§»å‹•æ¨¡æ“¬ã€
        
        // å–å¾—éµç›¤è¼¸å…¥ç‹€æ…‹ (A-Frame å…§å»º)
        // ç°¡å–®æ¨¡æ“¬ï¼šæŒçºŒè¼•å¾®ä¸Šä¸‹æµ®å‹•
        if (!this.isShaking) {
            this.timer += timeDelta * 0.005;
            this.el.object3D.position.y = this.baseY + Math.sin(this.timer) * 0.02;
        }
      },
      shake: function() {
        // P.15 äº’å‹•æ™‚é–‹å¿ƒçš„æ™ƒä¸€ä¸‹
        if(this.isShaking) return;
        this.isShaking = true;
        
        this.el.setAttribute('animation', {
          property: 'rotation',
          from: '0 180 0',
          to: '0 220 0',
          dir: 'alternate',
          dur: 150,
          loop: 4,
          easing: 'easeInOutQuad'
        });

        // å‹•ä½œçµæŸå¾Œå¾©åŸ
        setTimeout(() => {
          this.el.removeAttribute('animation');
          this.el.object3D.rotation.set(0, Math.PI, 0); // å›æ­£
          this.isShaking = false;
        }, 600);
      }
    });

    // --- Bibo äº’å‹•åµæ¸¬å™¨ ---
    AFRAME.registerComponent('bibo-interactor', {
      tick: function () {
        // å–å¾—ä¸»è§’ (Rig) çš„ä¸–ç•Œåº§æ¨™
        let rigPos = new THREE.Vector3();
        this.el.sceneEl.querySelector('#rig').object3D.getWorldPosition(rigPos);
        
        let npcs = document.querySelectorAll('[npc-behavior]');
        let hintBox = document.getElementById('interaction-hint');
        let isCloseToAny = false;

        npcs.forEach(npc => {
          let npcPos = new THREE.Vector3();
          npc.object3D.getWorldPosition(npcPos);
          // è¨ˆç®—è·é›¢ (3å…¬å°ºå…§)
          let dist = rigPos.distanceTo(npcPos);

          if (dist < 4.0) {
            isCloseToAny = true;
            let behavior = npc.components['npc-behavior'];
            
            // å¦‚æœé‚„æ²’äº’å‹•éï¼Œè§¸ç™¼äº’å‹•
            if (!behavior.hasInteracted) {
               behavior.interact(); // NPC åœä¸‹å‹•ä½œ
               this.el.components['bibo-walker'].shake(); // Bibo é–‹å¿ƒæ™ƒå‹•
               
               // å¢åŠ æ”¶é›†é€²åº¦ (ç°¡æ˜“é‚è¼¯)
               collectedNpcs++;
               if(collectedNpcs >= 3) { // å‡è¨­äº’å‹•3å€‹å°±å¯ä»¥åˆå¥
                  document.getElementById('ensemble-btn').classList.remove('hidden');
               }
            }
          } else {
            // é›¢é–‹è·é›¢ï¼ŒNPC æ¢å¾©å‹•ä½œ
            npc.components['npc-behavior'].resume();
          }
        });

        // UI é¡¯ç¤ºæ§åˆ¶
        if (isCloseToAny) {
          hintBox.style.display = 'block';
        } else {
          hintBox.style.display = 'none';
        }
      }
    });

    // --- NPC è¡Œç‚ºæ§åˆ¶ (æ ¸å¿ƒå‹•ç•«é‚è¼¯) ---
    AFRAME.registerComponent('npc-behavior', {
      schema: { type: { type: 'string', default: 'none' } },
      init: function () {
        this.isInteracting = false;
        this.hasInteracted = false; // ç´€éŒ„æ˜¯å¦å·²ç¶“è§¸ç™¼éç¬¬ä¸€æ¬¡
        this.setupIdleAnimation();
      },
      
      setupIdleAnimation: function () {
        // æ¸…é™¤èˆŠå‹•ç•«
        this.el.removeAttribute('animation__idle');
        
        switch (this.data.type) {
          case 'frog': 
            // é’è›™ï¼šé›™æ‰‹æ”¾é¬†æ‹è‚šå­ (Scale ç¸®æ”¾æ¨¡æ“¬) + å˜“å˜“è²
            this.el.setAttribute('animation__idle', {
              property: 'scale', from: '0.3 0.3 0.3', to: '0.35 0.28 0.35',
              dir: 'alternate', dur: 800, loop: true, easing: 'easeInOutSine'
            });
            break;
            
          case 'mushroom': 
            // è˜‘è‡ï¼šé–‹å¿ƒçš„å·¦å³æ™ƒå‹•
            this.el.setAttribute('animation__idle', {
              property: 'rotation', from: '0 0 -15', to: '0 0 15',
              dir: 'alternate', dur: 600, loop: true, easing: 'easeInOutQuad'
            });
            break;
            
          case 'rock': 
            // çŸ³é ­ï¼šæ„‰æ‚…åœ°å·¦å³æ»¾ä¾†æ»¾å» (å¹…åº¦è¼ƒå¤§)
            this.el.setAttribute('animation__idle', {
              property: 'rotation', from: '0 0 -45', to: '0 0 45',
              dir: 'alternate', dur: 1000, loop: true, easing: 'linear'
            });
            break;
            
          case 'tree': 
            // å¤§æ¨¹ï¼šè¼•é¬†æ–æ“º (æ¨¹æ ¹å›ºå®šï¼Œå¹…åº¦å°)
            this.el.setAttribute('animation__idle', {
              property: 'rotation', from: '2 0 0', to: '-2 0 0',
              dir: 'alternate', dur: 4000, loop: true, easing: 'easeInOutSine'
            });
            break;
            
          case 'bird': 
            // å°é³¥ï¼šçœ¨çœ¼(æ¨¡æ“¬) + 10ç§’é£›ä¸€æ¬¡
            // é€™è£¡åªè¨­å®šçœ¨çœ¼/å¾®å‹•ï¼Œé£›è¡Œç”± setInterval æ§åˆ¶
            this.el.setAttribute('animation__idle', {
              property: 'position', from: '0 2.2 0', to: '0 2.25 0', // è¼•å¾®è·³å‹•
              dir: 'alternate', dur: 200, loop: true, easing: 'easeOutQuad', pauseEvents: 'stop-anim'
            });
            this.startBirdRoutine();
            break;
            
          case 'flower': 
            // å–‡å­èŠ±ï¼šéŸ³ç¬¦é‚è¼¯
            this.startFlowerRoutine();
            break;
        }
      },

      // å°é³¥å°ˆå±¬ï¼š10ç§’é£›ä¸€æ¬¡
      startBirdRoutine: function() {
        if(this.birdInterval) clearInterval(this.birdInterval);
        this.birdInterval = setInterval(() => {
          if (this.isInteracting) return;
          // å‘ä¸Šé£›èµ·å‹•ç•«
          this.el.setAttribute('animation__fly', {
            property: 'position', to: '0 4 0', dir: 'alternate', dur: 1000, loop: 2
          });
          setTimeout(() => { this.el.removeAttribute('animation__fly'); }, 2000);
        }, 10000); // 10ç§’
      },

      // å–‡å­èŠ±å°ˆå±¬ï¼šå†’éŸ³ç¬¦
      startFlowerRoutine: function() {
        if(this.flowerInterval) clearInterval(this.flowerInterval);
        this.flowerInterval = setInterval(() => {
          if (this.isInteracting) return;
          let note = document.querySelector('#flower-note');
          if(note) {
            note.setAttribute('visible', 'true');
            note.setAttribute('animation', 'property: position; from: 0 2 0; to: 0 4 0; dur: 1500; easing: easeOutQuad');
            note.setAttribute('animation__fade', 'property: opacity; from: 1; to: 0; dur: 1500; easing: easeOutQuad');
            setTimeout(() => { note.setAttribute('visible', 'false'); }, 1500);
          }
        }, 2500);
      },

      // ç•¶ä¸»è§’é è¿‘æ™‚ï¼šåœä¸‹å‹•ä½œ
      interact: function () {
        if (this.isInteracting) return;
        this.isInteracting = true;
        this.hasInteracted = true;
        
        // ç§»é™¤é–’ç½®å‹•ç•« (è®“å®ƒçœ‹èµ·ä¾†åƒåœä¸‹ä¾†è½Biboèªªè©±)
        this.el.removeAttribute('animation__idle');
        
        // è¦–è¦ºå›é¥‹ï¼šç¨å¾®é¢å‘ç©å®¶æˆ–å®šæ ¼
        // é€™è£¡æˆ‘å€‘ç°¡å–®åšä¸€å€‹ "éœ‡å‹•" æç¤ºå®ƒæ³¨æ„åˆ°äº†
        this.el.setAttribute('animation__attn', {
            property: 'scale', to: String(this.el.object3D.scale.x * 1.2) + ' ' + String(this.el.object3D.scale.y * 1.2) + ' ' + String(this.el.object3D.scale.z * 1.2),
            dir: 'alternate', dur: 200, loop: 2
        });
      },

      // ç•¶ä¸»è§’é›¢é–‹æ™‚ï¼šæ¢å¾©å‹•ä½œ
      resume: function () {
        if (!this.isInteracting) return;
        this.isInteracting = false;
        this.el.removeAttribute('animation__attn');
        this.setupIdleAnimation();
      }
    });
  </script>
</body>
</html>
